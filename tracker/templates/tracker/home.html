{% extends 'tracker/base.html' %}
{% block title %}Dashboard | TRACKED{% endblock %}
{% block content %}
    <div class="toolbar">
        <button class="btn btn-primary" id="addTrackerBtn">+ Add Tracker</button>
        <div class="year-month-selector">
            <select class="year-select" id="yearSelect">
                <option value="2024" {% if current_month.year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if current_month.year == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if current_month.year == 2026 %}selected{% endif %}>2026</option>
            </select>
            <div class="month-selector">
                <button class="month-btn {% if current_month.month == 1 %}active{% endif %}" data-month="1">Jan</button>
                <button class="month-btn {% if current_month.month == 2 %}active{% endif %}" data-month="2">Feb</button>
                <button class="month-btn {% if current_month.month == 3 %}active{% endif %}" data-month="3">Mar</button>
                <button class="month-btn {% if current_month.month == 4 %}active{% endif %}" data-month="4">Apr</button>
                <button class="month-btn {% if current_month.month == 5 %}active{% endif %}" data-month="5">May</button>
                <button class="month-btn {% if current_month.month == 6 %}active{% endif %}" data-month="6">Jun</button>
                <button class="month-btn {% if current_month.month == 7 %}active{% endif %}" data-month="7">Jul</button>
                <button class="month-btn {% if current_month.month == 8 %}active{% endif %}" data-month="8">Aug</button>
                <button class="month-btn {% if current_month.month == 9 %}active{% endif %}" data-month="9">Sep</button>
                <button class="month-btn {% if current_month.month == 10 %}active{% endif %}" data-month="10">Oct</button>
                <button class="month-btn {% if current_month.month == 11 %}active{% endif %}" data-month="11">Nov</button>
                <button class="month-btn {% if current_month.month == 12 %}active{% endif %}" data-month="12">Dec</button>
            </div>
        </div>
    </div>
    <div class="spreadsheet-wrapper">
        <div class="spreadsheet-container">
            {% if trackers %}
                <div class="spreadsheet" id="spreadsheet">
                    <table class="tracker-table">
                        <thead>
                            <tr>
                                <th class="date-column">Date</th>
                                {% for tracker in trackers %}
                                    <th class="tracker-column">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                {{ tracker.name }}
                                            </div>
                                            <button class="delete-tracker-btn" data-tracker-id="{{ tracker.id }}" title="Delete tracker">×</button>
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for date in dates %}
                                <tr {% if date == today %}class="today"{% endif %}>
                                    <td class="date-cell">
                                        <div class="date-content">
                                            <span class="day-name">{{ date|date:"D" }}</span>
                                            <span class="date-num">{{ date|date:"d" }}</span>
                                        </div>
                                    </td>
                                    {% for tracker in trackers %}
                                        <td class="entry-cell" 
                                            data-tracker-id="{{ tracker.id }}"
                                            data-tracker-name="{{ tracker.name }}"
                                            data-date="{{ date|date:'Y-m-d' }}"
                                            data-date-display="{{ date|date:'M d, Y' }}"
                                            data-type="{{ tracker.tracker_type }}"
                                            data-week-id="week-{{ date|date:'Y-m-W' }}-tracker-{{ tracker.id }}">
                                            <span class="empty"></span>
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% if date|date:"w" == "0" or forloop.last %}
                                    <tr class="week-separator">
                                        <td class="week-label"><strong>Week Total</strong></td>
                                        {% for tracker in trackers %}
                                            <td class="week-total" 
                                                data-tracker-id="{{ tracker.id }}"
                                                data-tracker-type="{{ tracker.tracker_type }}"
                                                data-week-id="week-{{ date|date:'Y-m-W' }}-tracker-{{ tracker.id }}">
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No trackers yet</h3>
                    <p>Add your first tracker to start logging your life data</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Tracker Modal -->
    <div class="modal-overlay" id="addTrackerModal">
        <div class="modal">
            <div class="modal-header">Add New Tracker</div>
            <form method="post" action="{% url 'add_tracker' %}">
                {% csrf_token %}
                <div class="input-group">
                    <label class="input-label">Tracker name</label>
                    <input type="text" class="input" name="tracker_name" placeholder="e.g., Sleep, Calories, Workout" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Type</label>
                    <select class="select" name="tracker_type">
                        <option value="binary">Yes/No (Binary)</option>
                        <option value="number">Number</option>
                        <option value="time">Time</option>
                        <option value="duration">Duration (Start/End Time)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Unit (optional)</label>
                    <input type="text" class="input" name="tracker_unit" placeholder="e.g., cal, oz, ml, mins">
                </div>
                <div class="modal-actions">
                    <button class="btn" type="button" id="cancelBtn">Cancel</button>
                    <button class="btn btn-primary" type="submit">Add Tracker</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Entry Modal -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal">
            <div class="modal-header" id="entryModalTitle">Enter Value</div>
            <div class="entry-info">
                <div><strong>Tracker:</strong> <span id="entryTrackerName"></span></div>
                <div><strong>Date:</strong> <span id="entryDate"></span></div>
            </div>

            <!-- Binary Input -->
            <div id="binaryInput" style="display: none;">
                <div class="binary-buttons">
                    <button class="btn btn-success btn-large" data-value="true">Yes ✓</button>
                    <button class="btn btn-danger btn-large" data-value="false">No ✗</button>
                </div>
            </div>

            <!-- Number Input -->
            <div id="numberInput" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Value</label>
                    <input type="number" class="input" id="numberValue" step="any" placeholder="Enter number">
                </div>
            </div>

            <!-- Time Input -->
            <div id="timeInput" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Time</label>
                    <input type="time" class="input" id="timeValue">
                </div>
            </div>

            <!-- Duration Input -->
            <div id="durationInput" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Start Time</label>
                    <input type="time" class="input" id="durationStart">
                </div>
                <div class="input-group">
                    <label class="input-label">End Time</label>
                    <input type="time" class="input" id="durationEnd">
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-danger" type="button" id="deleteEntryBtn" style="margin-right: auto;">Delete</button>
                <button class="btn" type="button" id="cancelEntryBtn">Cancel</button>
                <button class="btn btn-primary" type="button" id="saveEntryBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const addTrackerModal = document.getElementById('addTrackerModal');
        const addTrackerBtn = document.getElementById('addTrackerBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        const entryModal = document.getElementById('entryModal');
        const cancelEntryBtn = document.getElementById('cancelEntryBtn');
        const saveEntryBtn = document.getElementById('saveEntryBtn');
        const deleteEntryBtn = document.getElementById('deleteEntryBtn');

        let currentTrackerId = null;
        let currentDate = null;
        let currentType = null;
        let currentCell = null;

        addTrackerBtn.addEventListener('click', () => {
            addTrackerModal.style.display = 'flex';
        });

        cancelBtn.addEventListener('click', () => {
            addTrackerModal.style.display = 'none';
        });

        addTrackerModal.addEventListener('click', (e) => {
            if (e.target === addTrackerModal) {
                addTrackerModal.style.display = 'none';
            }
        });

        document.querySelectorAll('.entry-cell').forEach(cell => {
            cell.addEventListener('click', () => {
                currentTrackerId = cell.dataset.trackerId;
                currentDate = cell.dataset.date;
                currentType = cell.dataset.type;
                currentCell = cell;

                document.getElementById('entryTrackerName').textContent = cell.dataset.trackerName;
                document.getElementById('entryDate').textContent = cell.dataset.dateDisplay;

                document.getElementById('binaryInput').style.display = 'none';
                document.getElementById('numberInput').style.display = 'none';
                document.getElementById('timeInput').style.display = 'none';
                document.getElementById('durationInput').style.display = 'none';

                if (currentType === 'binary') {
                    document.getElementById('binaryInput').style.display = 'block';
                } else if (currentType === 'number') {
                    document.getElementById('numberInput').style.display = 'block';
                    document.getElementById('numberValue').value = cell.textContent.trim() !== '-' ? cell.textContent.trim() : '';
                } else if (currentType === 'time') {
                    document.getElementById('timeInput').style.display = 'block';
                    document.getElementById('timeValue').value = cell.textContent.trim() !== '-' ? cell.textContent.trim() : '';
                } else if (currentType === 'duration') {
                    document.getElementById('durationInput').style.display = 'block';
                    const text = cell.textContent.trim();
                    if (text !== '-' && text.includes(' - ')) {
                        const [start, end] = text.split(' - ');
                        document.getElementById('durationStart').value = start.trim();
                        document.getElementById('durationEnd').value = end.trim();
                    }
                }

                entryModal.style.display = 'flex';
            });
        });

        document.querySelectorAll('#binaryInput .btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const value = btn.dataset.value === 'true';
                await updateEntry(currentTrackerId, currentDate, value, 'binary', currentCell);
                entryModal.style.display = 'none';
            });
        });

        saveEntryBtn.addEventListener('click', async () => {
            let value;
            if (currentType === 'number') {
                value = document.getElementById('numberValue').value;
                if (!value) return;
            } else if (currentType === 'time') {
                value = document.getElementById('timeValue').value;
                if (!value) return;
            } else if (currentType === 'duration') {
                const start = document.getElementById('durationStart').value;
                const end = document.getElementById('durationEnd').value;
                if (!start || !end) return;
                value = `${start} - ${end}`;
            }

            await updateEntry(currentTrackerId, currentDate, value, currentType, currentCell);
            entryModal.style.display = 'none';
        });

        deleteEntryBtn.addEventListener('click', async () => {
            await deleteEntry(currentTrackerId, currentDate, currentCell);
            entryModal.style.display = 'none';
        });

        cancelEntryBtn.addEventListener('click', () => {
            entryModal.style.display = 'none';
        });

        entryModal.addEventListener('click', (e) => {
            if (e.target === entryModal) {
                entryModal.style.display = 'none';
            }
        });

        async function updateEntry(trackerId, date, value, type, cell) {
            try {
                const response = await fetch('/entry/update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        tracker_id: trackerId,
                        date: date,
                        value: value
                    })
                });

                if (response.ok) {
                    if (type === 'binary') {
                        cell.innerHTML = value ? '✓' : '✗';
                    } else if (type === 'number') {
                        cell.innerHTML = value;
                    } else if (type === 'time') {
                        cell.innerHTML = value;
                    } else if (type === 'duration') {
                        cell.innerHTML = value;
                    }
                    
                    calculateWeekTotal(cell.dataset.weekId, cell.dataset.trackerId, type);
                } else {
                    alert('Error updating entry');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating entry');
            }
        }

        async function deleteEntry(trackerId, date, cell) {
            try {
                const response = await fetch('/entry/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        tracker_id: trackerId,
                        date: date
                    })
                });

                if (response.ok) {
                    cell.innerHTML = '<span class="empty"></span>';
                    
                    calculateWeekTotal(cell.dataset.weekId, cell.dataset.trackerId, cell.dataset.type);
                } else {
                    alert('Error deleting entry');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting entry');
            }
        }

        function calculateWeekTotal(weekId, trackerId, trackerType) {
            const cells = document.querySelectorAll(`.entry-cell[data-week-id="${weekId}"]`);
            const totalCell = document.querySelector(`.week-total[data-week-id="${weekId}"]`);
            
            if (!totalCell) return;
            
            let total = 0;
            let count = 0;
            let hasData = false;
            
            cells.forEach(cell => {
                const text = cell.textContent.trim();
                if (text !== '') {
                    hasData = true;
                    if (trackerType === 'binary') {
                        count++;
                        if (text === '✓') total++;
                    } else if (trackerType === 'number') {
                        const num = parseFloat(text);
                        if (!isNaN(num)) {
                            total += num;
                            count++;
                        }
                    }
                }
            });
            
            if (!hasData) {
                totalCell.textContent = '';
            } else if (trackerType === 'binary') {
                totalCell.textContent = `${total}/${count}`;
            } else if (trackerType === 'number') {
                totalCell.textContent = total.toFixed(1);
            } else {
                totalCell.textContent = '';
            }
        }

        function initializeWeekTotals() {
            const weekTotals = document.querySelectorAll('.week-total');
            weekTotals.forEach(totalCell => {
                const weekId = totalCell.dataset.weekId;
                const trackerId = totalCell.dataset.trackerId;
                const trackerType = totalCell.dataset.trackerType;
                calculateWeekTotal(weekId, trackerId, trackerType);
            });
        }

        initializeWeekTotals();

        // Year and Month selector
        const yearSelect = document.getElementById('yearSelect');
        const monthButtons = document.querySelectorAll('.month-btn');

        yearSelect.addEventListener('change', () => {
            const year = yearSelect.value;
            const activeMonth = document.querySelector('.month-btn.active');
            const month = activeMonth ? activeMonth.dataset.month : new Date().getMonth() + 1;
            window.location.href = `/?month=${year}-${String(month).padStart(2, '0')}`;
        });

        monthButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const month = btn.dataset.month;
                const year = yearSelect.value;
                window.location.href = `/?month=${year}-${String(month).padStart(2, '0')}`;
            });
        });

        // Delete tracker functionality
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-tracker-btn')) {
                const trackerId = e.target.dataset.trackerId;
                const trackerName = e.target.closest('th').textContent.trim().replace('×', '').trim();
                
                if (confirm(`Are you sure you want to delete "${trackerName}"? All entries will be deleted.`)) {
                    try {
                        const response = await fetch('/tracker/delete/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify({
                                tracker_id: trackerId
                            })
                        });
                        
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error deleting tracker');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error deleting tracker');
                    }
                }
            }
        });
    </script>
{% endblock %}