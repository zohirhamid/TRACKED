{% extends 'base.html' %}
{% load static %}
{% load tracker_extras %}

{% block title %}{{ month_name }} {{ year }} - TRACKED{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/grid.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Month Navigation -->
    <div class="month-header">
        <div class="month-nav">
            <a href="{% url 'tracker:month_view' year=prev_year month=prev_month %}" class="month-nav-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </a>
            <h1 class="month-title">{{ month_name }} {{ year }}</h1>
            <a href="{% url 'tracker:month_view' year=next_year month=next_month %}" class="month-nav-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
        </div>
        
        <!-- Month Tabs -->
        <div class="month-tabs">
            {% for m in months %}
            <a href="{% url 'tracker:month_view' year=year month=m.number %}" 
               class="month-tab {% if m.number == month %}active{% endif %}">
                {{ m.name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Check if user has trackers -->
    {% if not trackers %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
            </div>
            <h3>No trackers yet</h3>
            <p>Create your first tracker to start tracking your daily habits.</p>
            <a href="{% url 'tracker:tracker_create' %}" class="button-primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Tracker
            </a>
        </div>
    {% else %}
        <!-- Tracking Grid -->
        <div class="grid-container">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th class="grid-header grid-header-date">Date</th>
                        {% for tracker in trackers %}
                        <th class="grid-header" data-tracker-id="{{ tracker.id }}">
                            <div class="grid-header-content">
                                <span class="grid-header-name">{{ tracker.name }}</span>
                                {% if tracker.unit %}
                                <span class="grid-header-unit">{{ tracker.unit }}</span>
                                {% endif %}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for week in weeks %}
                        {% for day in week %}
                        <tr class="grid-row {% if day.date == today %}today{% endif %}" data-date="{{ day.date|date:'Y-m-d' }}">
                            <td class="grid-cell grid-cell-date">
                                <div class="grid-date">
                                    <span class="grid-date-day">{{ day.date.day }}</span>
                                    <span class="grid-date-weekday">{{ day.date|date:'D' }}</span>
                                </div>
                            </td>
                            {% for tracker in trackers %}
                            {% with entry=day.entries|get_item:tracker.id %}
                            <td class="grid-cell grid-cell-editable" 
                                data-tracker-id="{{ tracker.id }}"
                                data-tracker-type="{{ tracker.tracker_type }}"
                                data-date="{{ day.date|date:'Y-m-d' }}"
                                data-entry-id="{% if entry %}{{ entry.id }}{% endif %}">
                                
                                {% if entry %}
                                    <div class="grid-cell-value">
                                        {% if tracker.tracker_type == 'binary' %}
                                            {% if entry.binary_value %}
                                                <span class="grid-check">✓</span>
                                            {% else %}
                                                <span class="grid-cross">✗</span>
                                            {% endif %}
                                        {% elif tracker.tracker_type == 'number' %}
                                            <span class="grid-number">{{ entry.number_value }}</span>
                                        {% elif tracker.tracker_type == 'time' %}
                                            <span class="grid-time">{{ entry.time_value|time:'H:i' }}</span>
                                        {% elif tracker.tracker_type == 'duration' %}
                                            <span class="grid-duration">{{ entry.get_duration_display }}</span>                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="grid-cell-empty">—</div>
                                {% endif %}
                            </td>
                            {% endwith %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        
                        <!-- Week Summary Row -->
                        <tr class="grid-row-week-summary">
                            <td class="grid-cell-week-label">
                                <strong>Week {{ forloop.counter }}</strong>
                            </td>
                            {% for tracker in trackers %}
                            <td class="grid-cell-week-stat">
                                {{ week_stats|get_item:forloop.parentloop.counter0|get_item:tracker.id }}
                            </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Quick Stats (Optional) -->
        <div class="month-stats">
            <div class="stat-card">
                <div class="stat-label">Days Tracked</div>
                <div class="stat-value">{{ days_with_entries }}/{{ total_days }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completion Rate</div>
                <div class="stat-value">{{ completion_rate }}%</div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Edit Entry</h3>
        </div>
        <form id="editForm">
            <input type="hidden" id="editTrackerId">
            <input type="hidden" id="editDate">
            <input type="hidden" id="editEntryId">
            
            <div id="editFormContent">
                <!-- Dynamic form fields will be inserted here -->
            </div>

            <div class="modal-footer">
                <button type="button" class="button-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="button-primary" onclick="saveEntry()">
                    <span id="saveButtonText">Save</span>
                    <span id="saveButtonSpinner" class="spinner" style="display: none;"></span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/grid-editor.js' %}"></script>
<script src="{% static 'js/ajax-handler.js' %}"></script>
{% endblock %}